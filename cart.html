<!DOCTYPE html>
<!-- Updated: slim Flowery-style header/nav and BBE favicon. -->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bobby Black Exclusive | Cart</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="images/BBE-Favicon.png">

  <style>
    :root{--bg:#fafafa;--text:#111;--muted:#666;--card:#fff;--border:#eaeaea;--shadow:0 10px 28px rgba(0,0,0,.10);}
    *{box-sizing:border-box}
    body{font-family:Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}

    .site-header{
      background:#000;
      border-bottom:1px solid rgba(255,255,255,0.16);
      min-height:64px;
      display:flex;
      align-items:center;
      position:sticky;
      top:0;
      z-index:1000;
    }
    .header-inner{
      width:min(1200px, 100%);
      margin:0 auto;
      padding:10px 16px;
      display:grid;
      grid-template-columns:auto 1fr auto;
      align-items:center;
      gap:18px;
    }
    .brand-logo{
      height:34px;
      width:auto;
      display:block;
    }
    .main-nav{
      display:flex;
      gap:18px;
      align-items:center;
      flex-wrap:wrap;
    }
    .main-nav a{
      font-size:12px;
      letter-spacing:0.04em;
      text-transform:uppercase;
      text-decoration:none;
      color:#fff;
      opacity:0.92;
      transition:opacity .18s ease, color .18s ease;
    }
    .main-nav a:hover,.main-nav a:focus-visible{opacity:1;color:#d9d9d9}
    .header-search input[type="search"]{
      width:min(520px, 52vw);
      height:38px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.28);
      background:rgba(255,255,255,0.06);
      color:#fff;
      padding:0 14px;
      font-size:12px;
      letter-spacing:0.02em;
      outline:none;
      text-transform:uppercase;
    }
    .header-search input[type="search"]::placeholder{color:rgba(255,255,255,0.66)}
    .header-search input[type="search"]:focus{
      border-color:rgba(255,255,255,0.48);
      background:rgba(255,255,255,0.12);
    }

    .subtitle{margin-top:10px;font-size:13px;letter-spacing:2px;text-transform:uppercase;color:var(--muted)}
    .wrap{max-width:900px;margin:0 auto;padding:16px 16px 46px}
    .back{display:inline-block;margin-bottom:12px;text-decoration:none;font-weight:900;color:#111}

    .card{background:var(--card);border:1px solid var(--border);box-shadow:var(--shadow);border-radius:18px;padding:14px;margin-top:12px}
    .row{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .name{font-weight:900}
    .meta{color:#444;font-size:13px;margin-top:4px}
    .qty{display:flex;gap:8px;align-items:center}
    .btn{border:0;border-radius:999px;padding:8px 10px;font-weight:900;cursor:pointer}
    .btn.dark{background:#111;color:#fff}
    .btn.light{background:#eee;color:#111}
    .muted{color:var(--muted);font-size:13px}

    .total{margin-top:14px;font-weight:900;font-size:16px;display:flex;justify-content:space-between}
    .actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}

    .checkout-card{margin-top:14px}
    .checkout-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    .field label{font-size:12px;font-weight:900;letter-spacing:0.05em;text-transform:uppercase;color:#333}
    .input, .textarea{
      width:100%;
      border:1px solid rgba(0,0,0,0.12);
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      font-family:Arial,sans-serif;
      outline:none;
      background:#fff;
      color:#111;
    }
    .input:focus, .textarea:focus{border-color:#111}
    .textarea{min-height:92px;resize:vertical}
    .checkout-actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;align-items:center}
    .status{margin-top:10px;font-size:13px;line-height:1.45}
    .status.success{color:#0a7a3f}
    .status.error{color:#a11f1f}

    /* Screenshot mode */
    body.screenshot header,
    body.screenshot .actions,
    body.screenshot .back,
    body.screenshot .muted.smallhide,
    body.screenshot .checkout-card{display:none !important;}
    body.screenshot .wrap{padding-top:10px}

    @media(max-width:768px){
      .header-inner{grid-template-columns:1fr;gap:10px;justify-items:center;}
      .main-nav{justify-content:center;}
      .header-search{width:100%;}
      .header-search input[type="search"]{width:100%;}
      .checkout-grid{grid-template-columns:1fr;}
    }

  </style>
</head>
<body>
  <header class="site-header">
    <div class="header-inner">
      <a class="brand" href="/">
        <img class="brand-logo" src="images/Bobbyb.png" alt="Bobby Black" />
      </a>

      <nav class="main-nav" aria-label="Primary">
        <a href="brands.html">Brands</a>
        <a href="categories.html">Categories</a>
        <a href="about.html">About</a>
      </nav>

      <form class="header-search" role="search" action="#" method="GET">
        <input
          type="search"
          name="q"
          placeholder="WHAT CAN WE HELP YOU FIND?"
          aria-label="Search"
        />
      </form>
    </div>
  </header>
  <div class="subtitle">Cart & Checkout</div>

  <div class="wrap">
    <a class="back" href="index.html">← Back to Menu</a>

    <div class="muted smallhide">
      Build your cart, review your totals, and place your order request securely.
    </div>

    <div id="cartList"></div>

    <div class="card">
      <div class="total">
        <div>Subtotal</div>
        <div id="subtotal">$0</div>
      </div>

      <div class="actions">
        <button class="btn light" id="clearCart">Clear Cart</button>
        <button class="btn dark" id="screenshotMode">Screenshot View</button>
        <button class="btn light" id="exitScreenshot" style="display:none;">Exit Screenshot</button>
      </div>

      <div class="muted" style="margin-top:10px;">
        Tip: On iPhone/Android, screenshot normally. On desktop, use the browser screenshot tool.
      </div>
    </div>


    <div class="card checkout-card">
      <div class="name" style="margin-bottom:10px;">Checkout</div>
      <form id="checkoutForm" novalidate>
        <div class="checkout-grid">
          <div class="field">
            <label for="customerName">Customer Name *</label>
            <input class="input" id="customerName" name="customerName" maxlength="80" required />
          </div>
          <div class="field">
            <label for="customerPhone">Phone *</label>
            <input class="input" id="customerPhone" name="customerPhone" maxlength="40" required />
          </div>
          <div class="field">
            <label for="customerEmail">Email (optional)</label>
            <input class="input" id="customerEmail" name="customerEmail" type="email" maxlength="120" />
          </div>
          <div class="field" style="grid-column:1/-1;">
            <label for="specialInstructions">Special Instructions (optional)</label>
            <textarea class="textarea" id="specialInstructions" name="specialInstructions" maxlength="800"></textarea>
          </div>
        </div>

        <div class="checkout-actions">
          <button class="btn dark" id="placeOrderBtn" type="submit">Place Order</button>
          <span class="muted">Orders are sent directly to Bobby Black staff by email.</span>
        </div>
        <div id="checkoutStatus" class="status" role="status" aria-live="polite"></div>
      </form>
    </div>
  </div>

  <script src="cart.js"></script>
  <script>
    function money(n){ return BBE_CART.money(n); }

    const checkoutForm = document.getElementById("checkoutForm");
    const placeOrderBtn = document.getElementById("placeOrderBtn");
    const checkoutStatus = document.getElementById("checkoutStatus");

    function setCheckoutStatus(message, type){
      checkoutStatus.textContent = message || "";
      checkoutStatus.className = "status" + (type ? " " + type : "");
    }

    function getSubtotal(cart){
      return cart.reduce((sum, line) => {
        const qty = Number(line.qty) || 0;
        const price = Number(line.unitPrice) || 0;
        return sum + qty * price;
      }, 0);
    }

    function render(){
      const list = document.getElementById("cartList");
      const cart = BBE_CART.loadCart();

      list.innerHTML = "";

      if(cart.length === 0){
        list.innerHTML = `<div class="card"><div class="muted">Your cart is empty.</div></div>`;
        document.getElementById("subtotal").textContent = "$0";
        return;
      }

      const subtotal = getSubtotal(cart);

      cart.forEach((line, idx) => {
        const qty = Number(line.qty) || 0;
        const price = Number(line.unitPrice) || 0;
        const lineTotal = qty * price;

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="row">
            <div style="flex:1;">
              <div class="name">${line.name}</div>
              <div class="meta">
                ${line.category}${line.subcategory ? " • " + line.subcategory : ""}${line.variantLabel ? " • " + line.variantLabel : ""}
              </div>
              <div class="meta">${money(price)} each</div>
            </div>

            <div class="qty">
              <button class="btn light" data-dec="${idx}">−</button>
              <div style="min-width:24px;text-align:center;font-weight:900;">${qty}</div>
              <button class="btn light" data-inc="${idx}">+</button>
            </div>
          </div>

          <div class="total" style="margin-top:10px;font-size:14px;">
            <div class="muted">Line total</div>
            <div>${money(lineTotal)}</div>
          </div>

          <div class="actions" style="margin-top:10px;">
            <button class="btn light" data-remove="${idx}">Remove</button>
          </div>
        `;

        list.appendChild(card);
      });

      document.getElementById("subtotal").textContent = money(subtotal);

      list.querySelectorAll("[data-inc]").forEach(btn=>{
        btn.onclick = () => {
          const i = Number(btn.getAttribute("data-inc"));
          const cart = BBE_CART.loadCart();
          cart[i].qty = (Number(cart[i].qty)||0) + 1;
          BBE_CART.saveCart(cart);
          render();
        };
      });

      list.querySelectorAll("[data-dec]").forEach(btn=>{
        btn.onclick = () => {
          const i = Number(btn.getAttribute("data-dec"));
          const cart = BBE_CART.loadCart();
          cart[i].qty = Math.max(1, (Number(cart[i].qty)||1) - 1);
          BBE_CART.saveCart(cart);
          render();
        };
      });

      list.querySelectorAll("[data-remove]").forEach(btn=>{
        btn.onclick = () => {
          const i = Number(btn.getAttribute("data-remove"));
          const cart = BBE_CART.loadCart();
          cart.splice(i,1);
          BBE_CART.saveCart(cart);
          render();
        };
      });
    }

    function validateCheckout(name, phone, email, specialInstructions){
      if(!name) return "Name is required.";
      if(name.length > 80) return "Name must be 80 characters or fewer.";
      if(!phone) return "Phone is required.";
      if(phone.length > 40) return "Phone must be 40 characters or fewer.";
      if(email && email.length > 120) return "Email must be 120 characters or fewer.";
      if(specialInstructions.length > 800) return "Special instructions must be 800 characters or fewer.";
      return "";
    }

    checkoutForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      const cart = BBE_CART.loadCart();
      if(!cart.length){
        setCheckoutStatus("Your cart is empty. Add items before placing an order.", "error");
        return;
      }

      const formData = new FormData(checkoutForm);
      const name = String(formData.get("customerName") || "").trim();
      const phone = String(formData.get("customerPhone") || "").trim();
      const emailRaw = String(formData.get("customerEmail") || "").trim();
      const specialInstructions = String(formData.get("specialInstructions") || "").trim();

      const validationError = validateCheckout(name, phone, emailRaw, specialInstructions);
      if(validationError){
        setCheckoutStatus(validationError, "error");
        return;
      }

      const subtotal = getSubtotal(cart);
      const payload = {
        customer: {
          name,
          phone,
          email: emailRaw || null,
        },
        order: {
          items: cart.map((line) => ({
            id: String(line.id || ""),
            name: String(line.name || ""),
            qty: Math.max(1, Number(line.qty) || 1),
            price: Math.max(0, Number(line.unitPrice) || 0),
            variant: line.variantLabel ? String(line.variantLabel) : null,
            notes: line.notes ? String(line.notes) : null,
          })),
          subtotal,
          tax: null,
          fees: null,
          total: subtotal,
          method: "unknown",
          address: null,
          specialInstructions: specialInstructions || null,
        }
      };

      placeOrderBtn.disabled = true;
      placeOrderBtn.textContent = "Sending...";
      setCheckoutStatus("", "");

      try {
        const response = await fetch("/api/order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        let data = {};
        try { data = await response.json(); } catch {}

        if(response.ok && data.ok){
          const orderId = data.id ? ` (${data.id})` : "";
          setCheckoutStatus(`Order request sent successfully${orderId}. We'll contact you shortly.`, "success");
          BBE_CART.saveCart([]);
          render();
          checkoutForm.reset();
          return;
        }

        setCheckoutStatus(data.error || "We couldn't send your order right now. Please try again.", "error");
      } catch (error) {
        console.error(error);
        setCheckoutStatus("Network error. Please check your connection and try again.", "error");
      } finally {
        placeOrderBtn.disabled = false;
        placeOrderBtn.textContent = "Place Order";
      }
    });

    document.getElementById("clearCart").onclick = () => {
      if(confirm("Clear your cart?")){
        BBE_CART.saveCart([]);
        render();
      }
    };

    document.getElementById("screenshotMode").onclick = () => {
      document.body.classList.add("screenshot");
      document.getElementById("exitScreenshot").style.display = "inline-block";
      document.getElementById("screenshotMode").style.display = "none";
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    document.getElementById("exitScreenshot").onclick = () => {
      document.body.classList.remove("screenshot");
      document.getElementById("exitScreenshot").style.display = "none";
      document.getElementById("screenshotMode").style.display = "inline-block";
    };

    render();
  </script>
</body>
</html>
